
--- 
title:  【STM32】DMA—直接存储器存取（原理篇） 
tags: []
categories: [] 

---
>  
 🆔作者简介：一名电子信息大学生. 📑 个人主页： 📫 如果文章知识点有错误的地方,请指正！和大家一起学习进步 🔥 如果感觉博主的文章还不错的话，还请不吝关注、点赞、收藏 




#### 文章目录
- - - - <ul><li>- - - <ul><li>- - 


## 前言

因为这学期开设了《ARM Cortex-M3嵌入式原理及应用》这门课，所以本篇博客旨在记录课程的学习内容也是我的学习笔记。同时也是我对STM32F103系列单片机学习内容的总结，为保持对嵌入式技术的持续学习，我会坚持每周更新一至两篇博客。

这篇有关DMA工作原理的博客，是博主在看完正点原子、野火的视频讲解和STM32F103参考手册后，自己对于的DMA工作原理的理解。

`提示：以下是本篇文章正文内容`

## 一、DMA是什么？

<img src="https://img-blog.csdnimg.cn/7e71fe2d2c11439abf6b178c9911b30d.png#pic_center" alt="在这里插入图片描述">直接存储器存取(DMA)用来提供在外设和存储器之间或者存储器和存储器之间的高速数据传输。无须CPU干预，数据可以通过DMA快速地移动，这就节省了CPU的资源来做其他操作。两个DMA控制器有12个通道(DMA1有7个通道，DMA2有5个通道)，每个通道专门用来管理来自于一个或多个外设对存储器访问的请求。还有一个仲裁器来协调各个DMA请求的优先权。**FLASH、SRAM、外设的SRAM、APB1、APB2和AHB外设均可作为访问的源和目标！**

## 二、DMA的工作原理是什么？

### 1.DMA的工作流程分析

<img src="https://img-blog.csdnimg.cn/ef0e81e110934029894127886f19a4ca.png#pic_center" alt="在这里插入图片描述">在发生一个事件后，外设向DMA控制器发送一个请求信号。DMA控制器根据通道的优先权处理请求。当DMA控制器开始访问发出请求的外设时，DMA控制器立即发送给它一个应答信号。当从DMA控制器得到应答信号时，外设立即释放它的请求。一旦外设释放了这个请求，DMA控制器同时撤销应答信号。如果有更多的请求时，外设可以启动下一个周期。 总之，每次DMA传送由3个操作组成：

● **从外设数据寄存器或者从当前外设/存储器地址寄存器指示的存储器地址取数据，第一次传 输时的开始地址是DMA_CPARx或DMA_CMARx寄存器指定的外设基地址或存储器单元。**

● **存数据到外设数据寄存器或者当前外设/存储器地址寄存器指示的存储器地址，第一次传输 时的开始地址是DMA_CPARx或DMA_CMARx寄存器指定的外设基地址或存储器单元。**

● **执行一次DMA_CNDTRx寄存器的递减操作，该寄存器包含未完成的操作数目。**

**仲裁器根据通道请求的优先级来启动外设/存储器的访问。** 优先权管理分2个阶段： ● 软件：每个通道的优先权可以在DMA_CCRx寄存器中设置，有4个等级： ─ 最高优先级 ─ 高优先级 ─ 中等优先级 ─ 低优先级 ● 硬件：如果2个请求有相同的软件优先级，则较低编号的通道比较高编号的通道有较高的优 先权。举个例子，通道2优先于通道4。 注意： 在大容量产品和互联型产品中，DMA1控制器拥有高于DMA2控制器的优先级

### 2.DMA的传输数据的流程

<img src="https://img-blog.csdnimg.cn/f3cdaa808027470c8a7ac8c4b31d9a11.png#pic_center" alt="在这里插入图片描述">**有关DMA通道传输数据的流程如下：** 下面是配置DMA通道x的过程(x代表通道号)：
-  在DMA_CPARx寄存器中设置外设寄存器的地址。发生外设数据传输请求时，这个地址将是数据传输的源或目标。 -  在DMA_CMARx寄存器中设置数据存储器的地址。发生外设数据传输请求时，传输的数据将从这个地址读出或写入这个地址。 -  在DMA_CNDTRx寄存器中设置要传输的数据量。在每个数据传输后，这个数值递减。 -  在DMA_CCRx寄存器的PL[1:0]位中设置通道的优先级。 -  在DMA_CCRx寄存器中设置数据传输的方向、循环模式、外设和存储器的增量模式、外设和存储器的数据宽度、传输一半产生中断或传输完成产生中断。 -  设置DMA_CCRx寄存器的ENABLE位，启动该通道。一旦启动了DMA通道，它既可响应连到该通道上的外设的DMA请求。当传输一半的数据后，半传输标志(HTIF)被置1，当设置了允许半传输中断位(HTIE)时，将产生一个中断请求。在数据传输结束后，传输完成标志(TCIF)被置1，当设置了允许传输完成中断位(TCIE)时，将产生一个中断请求。 
### 3.DMA工作原理图

<img src="https://img-blog.csdnimg.cn/840a2624bce44ffda7876c7b0d6098f8.png#pic_center" alt="在这里插入图片描述">

#### a、DMA各通道请求框图

首先，我们要了解 ****DMA各通道请求框图**** 是 ****DMA系统框图**** 中的具体哪一部分电路。我们再去分析DMA各通道请求框图的具体功能，这样有助于我们在摸清DMA工作的电路框图脉络。 <img src="https://img-blog.csdnimg.cn/c1c88c28625146f293e1e3f9cd1fa213.png" alt="在这里插入图片描述"> **（1）DMA1控制器** 从外设(TIMx[x=1、2、3、4]、ADC1、SPI1、SPI/I2S2、I2Cx[x=1、2]和USARTx[x=1、2、3])产生的7个请求，通过逻辑或输入到DMA1控制器，这意味着同时**只能有一个请求有效**。参见下图的DMA1请求映像。**外设的DMA请求，可以通过设置相应外设寄存器中的控制位，被独立地开启或关闭。** <img src="https://img-blog.csdnimg.cn/f0b345dadb7f4febb71a2fbdbf84abc5.png#pic_center" alt="在这里插入图片描述"> **（2）DMA2控制器** 从外设(TIMx[5、6、7、8]、ADC3、SPI/I2S3、UART4、DAC通道1、2和SDIO)产生的5个请求，经逻辑或输入到DMA2控制器，这意味着同时**只能有一个请求有效**。参见下图的DMA2请求映像。**外设的DMA请求，可以通过设置相应外设寄存器中的DMA控制位，被独立地开启或关闭。** 注意： DMA2控制器及相关请求仅存在于大容量产品和互联型产品中。 <img src="https://img-blog.csdnimg.cn/77a9d161d65440d5aecf690468210c66.png#pic_center" alt="在这里插入图片描述">

#### b、DMA工作的系统框图

● 12个独立的可配置的通道(请求)：**DMA1有7个通道**，**DMA2有5个通道** ● 每个通道都直接连接专用的硬件DMA请求，每个通道都同样支持软件触发。这些功能通过软件来配置。 ● 在同一个DMA模块上，多个请求间的**优先权**可以通过软件编程设置(**共有四级：很高、高、中等和低**)，优先权设置相等时由硬件决定(请求0优先于请求1，依此类推) 。 ● 独立数据源和目标数据区的**传输宽度**(**字节、半字、全字**)，模拟打包和拆包的过程。源和目标地址必须按**数据传输宽度对齐**。 ● 支持循环的缓冲器管理 ● 每个通道都有3个事件标志(**DMA半传输、DMA传输完成和DMA传输出错**)，这3个事件标志逻辑或成为一个单独的中断请求。 ● 存储器和存储器间的传输 ● **外设和存储器**、**存储器和外设**之间的传输 ● ****闪存、SRAM、外设的SRAM、APB1、APB2和AHB外设均可作为访问的源和目标****。 ● 可编程的数据传输数目：**最大为65535** <img src="https://img-blog.csdnimg.cn/b26f172b4ed743abadd3b13bed0bd013.png#pic_center" alt="在这里插入图片描述">

**DMA的工作的流程如下图的箭头所示：** <img src="https://img-blog.csdnimg.cn/c1f94dd6637442359237ee11ed9121f2.png#pic_center" alt="在这里插入图片描述">

#### c、DMA各通道请求总结表

**下面这个表是对DMA1的7个通道上所挂着的外设资源的汇总表**。 有了这个表我们就能一目了然的看出，STM32的片上外设资源挂在DMA1的哪个通道。如ADC1外设就挂在DMA1的通道1上。即我们想要用DMA1获取ADC1的信息存储到SRAM里面的话，DMA1只能通过通道1去获取信ADC1的I/O口采集的信息，而不能通过其他的通道，其他的外设均是以此类推。 <img src="https://img-blog.csdnimg.cn/09a3fa3ff87c4c6a84f40a7bec6e0770.png#pic_center" alt="在这里插入图片描述"> **下面这个表是对DMA2的5个通道上所挂着的外设资源的汇总表。** <img src="https://img-blog.csdnimg.cn/f1e72c08a9a942b9bd2b29078b898566.png#pic_center" alt="在这里插入图片描述">

## 三、DMA的如何使用？

<img src="https://img-blog.csdnimg.cn/5eb8ef4c0d904d7f97edb3b4427187e1.png#pic_center" alt="在这里插入图片描述">有关DMA的使用将在【STM32】DMA—直接存储器访问（实践篇）讲解！

## 总结

**本篇博客主要分享了STM32F103系列单片机的 DMA—直接存储器访问 存取是的工作原理。那么今天的分享就到这里吧 如果觉得博主的这篇文章不错的话麻烦给博主一个三连。你的三连就是对我最大的支持！**
- 小容量产品是指闪存存储器容量在16K至32K字节之间的STM32F101xxSTM32F102xx和STM32F103xx微控制器。- 中容量产品是指闪存存储器容量在64K至128K字节之间的STM32F101xx、STM32F102xx和STM32F103xx微控制器。- 大容量产品是指闪存存储器容量在256K至512K字节之间的STM32F101xx和STM32F103xx微控制器。- 互联型产品是指STM32F105xx和STM32F107xx微控制器。