
--- 
title:  Python 解析 spec 文件 
tags: []
categories: [] 

---
参考链接：

### 安装模块

先使用 pip 安装 python-rpm-spec 模块

```
pip3 install python-rpm-spec
```

### 使用示例

**test.spec**

```
Name:           pandas
Version:        0.25.3
Release:        2
Summary:        Data structures and data analysis tools for Python
License:        BSD
URL:            https://pandas.pydata.org/
Source0:        https://github.com/pandas-dev/pandas/releases/download/v%{version}/%{pypi_name}-%{version}.tar.gz

BuildRequires:  gcc gcc-c++ gdb-headless
BuildRequires:  python3-devel python3-setuptools python3-numpy
%if %{with test}
BuildRequires:  python3-pytest &gt;= 4.0.2
%endif

Requires: python3-numpy python3-dateutil python3-pytz
Conflicts: conflicts-test

Provides: provides-test
Obsoletes: obsoletes-test

```

**test.py** 

```
# pip3 install python-rpm-spec
from pyrpm.spec import Spec

spec_path = 'test.spec'
spec = Spec.from_file(spec_path)

print('Name:'.ljust(20), spec.name)
print('Version:'.ljust(20), spec.version)
print('Release:'.ljust(20), spec.release)
print('Summary:'.ljust(20), spec.summary)
print('License:'.ljust(20), spec.license)
print('URL:'.ljust(20), spec.url)
print('Source0:'.ljust(20), spec.sources[0])
print('Requires:'.ljust(20), spec.requires)
print('BuildRequires:'.ljust(20), spec.build_requires)
print('Provides:'.ljust(20), spec.provides)
print('Conflicts:'.ljust(20), spec.conflicts)
print('Obsoletes:'.ljust(20), spec.obsoletes)
print('SourceList:'.ljust(20), spec.sources)
print('SourceDict:'.ljust(20), spec.sources_dict)

# build_requires = []
# for br in spec.build_requires:
#     build_requires.append(f'{br.name} {br.operator} {br.version}' if br.version else f'{br.name}')
# print('BuildRequires:'.ljust(20), build_requires)

```

**result**

```
Name:                pandas
Version:             0.25.3
Release:             2
Summary:             Data structures and data analysis tools for Python
License:             BSD
URL:                 https://pandas.pydata.org/
Source0:             https://github.com/pandas-dev/pandas/releases/download/v%{version}/%{pypi_name}-%{version}.tar.gz
Requires:            [python3-numpy, python3-dateutil, python3-pytz]
BuildRequires:       [gcc, gcc-c++, gdb-headless, python3-devel, python3-setuptools, python3-numpy, python3-pytest &gt;= 4.0.2]
Provides:            [provides-test]
Conflicts:           [conflicts-test]
Obsoletes:           [obsoletes-test]
SourceList:          ['https://github.com/pandas-dev/pandas/releases/download/v%{version}/%{pypi_name}-%{version}.tar.gz']
SourceDict:          {'Source0': 'https://github.com/pandas-dev/pandas/releases/download/v%{version}/%{pypi_name}-%{version}.tar.gz'}
```

### 其他字段

当然，如果你好奇心更严重一点，或许可以从 spec.py 的源码文件看出一些端倪，因为它其实也是使用的正则匹配去获取 spec 文件对应的这些内容的，只不过通过封装添加了一些额外的处理，下面展示了一些其他可能会进行正则匹配的字段。

```
_tags = [
    _NameValue("name", re_tag_compile(r"^Name\s*:\s*(\S+)")),
    _NameValue("version", re_tag_compile(r"^Version\s*:\s*(\S+)")),
    _NameValue("epoch", re_tag_compile(r"^Epoch\s*:\s*(\S+)")),
    _NameValue("release", re_tag_compile(r"^Release\s*:\s*(\S+)")),
    _NameValue("summary", re_tag_compile(r"^Summary\s*:\s*(.+)")),
    _NameValue("description", re_tag_compile(r"^%description\s*(\S*)")),
    _NameValue("changelog", re_tag_compile(r"^%changelog\s*(\S*)")),
    _NameValue("license", re_tag_compile(r"^License\s*:\s*(.+)")),
    _NameValue("group", re_tag_compile(r"^Group\s*:\s*(.+)")),
    _NameValue("url", re_tag_compile(r"^URL\s*:\s*(\S+)")),
    _NameValue("buildroot", re_tag_compile(r"^BuildRoot\s*:\s*(\S+)")),
    _SplitValue("buildarch", re_tag_compile(r"^BuildArch\s*:\s*(\S+)")),
    _SplitValue("excludearch", re_tag_compile(r"^ExcludeArch\s*:\s*(.+)")),
    _SplitValue("exclusivearch", re_tag_compile(r"^ExclusiveArch\s*:\s*(.+)")),
    _ListAndDict("sources", re_tag_compile(r"^(Source\d*\s*):\s*(.+)")),
    _ListAndDict("patches", re_tag_compile(r"^(Patch\d*\s*):\s*(\S+)")),
    _List("build_requires", re_tag_compile(r"^BuildRequires\s*:\s*(.+)")),
    _List("requires", re_tag_compile(r"^Requires\s*:\s*(.+)")),
    _List("conflicts", re_tag_compile(r"^Conflicts\s*:\s*(.+)")),
    _List("obsoletes", re_tag_compile(r"^Obsoletes\s*:\s*(.+)")),
    _List("provides", re_tag_compile(r"^Provides\s*:\s*(.+)")),
    _List("packages", re.compile(r"^%package\s+(\S+)")),
    _MacroDef("define", re.compile(r"^%define\s+(\S+)\s+(\S+)")),
    _MacroDef("global", re.compile(r"^%global\s+(\S+)\s+(\S+)")),
    _DummyMacroDef("dummy", re.compile(r"^%[a-z_]+\b.*$")),
]
```

### 相似命令

当然，rpmspec 命令也可以从 spec 提取一部分信息出来。

```
[root@master ~]# rpmspec --help
Usage: rpmspec [OPTION...]

Spec options:
  -P, --parse                   parse spec file(s) to stdout
  -q, --query                   query spec file(s)
  --rpms                        operate on binary rpms generated by spec (default)
  --srpm                        operate on source rpm generated by spec
  --target=STRING               override target platform
  --queryformat=QUERYFORMAT     use the following query format

Common options for all rpm modes and executables:
  -D, --define='MACRO EXPR'     define MACRO with value EXPR
  --undefine=MACRO              undefine MACRO
  -E, --eval='EXPR'             print macro expansion of EXPR
  --macros=&lt;FILE:...&gt;           read &lt;FILE:...&gt; instead of default file(s)
  --noplugins                   don't enable any plugins
  --nodigest                    don't verify package digest(s)
  --nosignature                 don't verify package signature(s)
  --rcfile=&lt;FILE:...&gt;           read &lt;FILE:...&gt; instead of default file(s)
  -r, --root=ROOT               use ROOT as top level directory (default: "/")
  --dbpath=DIRECTORY            use database in DIRECTORY
  --querytags                   display known query tags
  --showrc                      display final rpmrc and macro configuration
  --quiet                       provide less detailed output
  -v, --verbose                 provide more detailed output
  --version                     print the version of rpm being used

Options implemented via popt alias/exec:
  --conflicts                   list capabilities this package conflicts with
  --obsoletes                   list other packages removed by installing this package
  --provides                    list capabilities that this package provides
  --requires                    list capabilities required by package(s)
  --buildconflicts              list capabilities conflicting with build of this package
  --buildrequires               list capabilities required to build this package

Help options:
  -?, --help                    Show this help message
  --usage                       Display brief usage message

```


