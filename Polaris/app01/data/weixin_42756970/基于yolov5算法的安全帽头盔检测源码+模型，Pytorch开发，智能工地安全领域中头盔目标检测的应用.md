
--- 
title:  åŸºäºyolov5ç®—æ³•çš„å®‰å…¨å¸½å¤´ç›”æ£€æµ‹æºç +æ¨¡å‹ï¼ŒPytorchå¼€å‘ï¼Œæ™ºèƒ½å·¥åœ°å®‰å…¨é¢†åŸŸä¸­å¤´ç›”ç›®æ ‡æ£€æµ‹çš„åº”ç”¨ 
tags: []
categories: [] 

---
## åŸºäºyolov5ç®—æ³•çš„å®‰å…¨å¸½å¤´ç›”æ£€æµ‹|Pytorchå¼€å‘+æºç +æ¨¡å‹

æœ¬æœŸç»™å¤§å®¶æ‰“å¼€çš„æ˜¯YOLOv5åœ¨æ™ºèƒ½å·¥åœ°å®‰å…¨é¢†åŸŸä¸­å¤´ç›”ç›®æ ‡æ£€æµ‹çš„åº”ç”¨ã€‚

å®Œæ•´ä»£ç ä¸‹è½½åœ°å€ï¼š

### å¯è§†åŒ–ç•Œé¢æ¼”ç¤ºï¼š

ğŸ’¥ğŸ’¥ğŸ’¥æ–°å¢å¯è§†åŒ–ç•Œé¢ä¸Šçº¿å•¦ï¼ï¼ï¼ï¼æ¥ä¸€æ³¢æ¼”ç¤ºï¼ï¼ï¼

<img src="https://img-blog.csdnimg.cn/img_convert/157c2b7b62a711a9854ad5948aa654ed.gif" alt="">

### æ¼”ç¤º

<img src="https://img-blog.csdnimg.cn/img_convert/a4cbfb5472a4672be2852f60d64ad50e.jpeg" alt=""> <img src="https://img-blog.csdnimg.cn/img_convert/9ebde323b99519631809dd13bfd455bb.jpeg" alt=""> <img src="https://img-blog.csdnimg.cn/img_convert/418966e581ab4942dd9d27c88d1f24d7.jpeg" alt=""> <img src="https://img-blog.csdnimg.cn/img_convert/22546eed4705ebc72341b96696aac85a.jpeg" alt="">

### æŒ‡æ ‡

#### yolov5s ä¸ºåŸºç¡€è®­ç»ƒï¼Œ`epoch = 50`

|åˆ†ç±»|P|R|mAP0.5
|------
|æ€»ä½“|0.884|0.899|0.888
|äººä½“|0.846|0.893|0.877
|å¤´|0.889|0.883|0.871
|å®‰å…¨å¸½|0.917|0.921|0.917

å¯¹åº”çš„**æƒé‡æ–‡ä»¶**ï¼šï¼Œæå–ç : `b981`

#### yolov5m ä¸ºåŸºç¡€è®­ç»ƒï¼Œ`epoch = 100`

|åˆ†ç±»|P|R|mAP0.5
|------
|æ€»ä½“|0.886|0.915|0.901
|äººä½“|0.844|0.906|0.887
|å¤´|0.9|0.911|0.9
|å®‰å…¨å¸½|0.913|0.929|0.916

å¯¹åº”çš„**æƒé‡æ–‡ä»¶**ï¼šï¼Œæå–ç : `psst`

#### yolov5l ä¸ºåŸºç¡€è®­ç»ƒï¼Œ`epoch = 100`

|åˆ†ç±»|P|R|mAP0.5
|------
|æ€»ä½“|0.892|0.919|0.906
|äººä½“|0.856|0.914|0.897
|å¤´|0.893|0.913|0.901
|å®‰å…¨å¸½|0.927|0.929|0.919

å¯¹åº”çš„**æƒé‡æ–‡ä»¶**ï¼šï¼Œæå–ç : `a66e`

## 1.YOLO v5è®­ç»ƒè‡ªå·±æ•°æ®é›†æ•™ç¨‹

ä½¿ç”¨çš„æ•°æ®é›†ï¼š ï¼Œæ„Ÿè°¢è¿™ä½å¤§ç¥çš„å¼€æºæ•°æ®é›†ï¼

>  
 æœ¬æ–‡ç»“åˆ  æ¥å†™ 


### ç¯å¢ƒå‡†å¤‡

é¦–å…ˆç¡®ä¿è‡ªå·±çš„ç¯å¢ƒï¼š

```
    Python&gt;=3.7
    Pytorch==1.5.x
    PyQt5==5.15.3
    PyQtChart==5.15.3
    PyQt5-tools
    GPUtil

```

æˆ–è€…ä½¿ç”¨æˆ‘çš„ç¯å¢ƒï¼ˆæ¨èï¼‰

```
pip install -r requirements.txt

```

### å®˜æ–¹æƒé‡

æˆ‘å·²ä¸Šä¼ åˆ°ä¸€ä»½åˆ°ç™¾åº¦äº‘ï¼š , å¯†ç : `44qm`

### è®­ç»ƒè‡ªå·±çš„æ•°æ®

##### æç¤ºï¼š

**å…³äºå¢åŠ æ•°æ®é›†åˆ†ç±»çš„æ–¹æ³•ï¼Œè¯·çœ‹ã€5. å¢åŠ æ•°æ®é›†çš„åˆ†ç±»ã€‘**

#### 1.1 åˆ›å»ºè‡ªå·±çš„æ•°æ®é›†é…ç½®æ–‡ä»¶

å› ä¸ºæˆ‘è¿™é‡Œåªæ˜¯åˆ¤æ–­ ã€äººæ²¡æœ‰å¸¦å®‰å…¨å¸½ã€‘ã€ã€äººæœ‰å¸¦å®‰å…¨å¸½ã€‘ã€ã€äººä½“ã€‘ 3ä¸ªç±»åˆ« ï¼ŒåŸºäº `data/coco128.yaml` æ–‡ä»¶ï¼Œåˆ›å»ºè‡ªå·±çš„æ•°æ®é›†é…ç½®æ–‡ä»¶ `custom_data.yaml`

```

# è®­ç»ƒé›†å’ŒéªŒè¯é›†çš„ labels å’Œ image æ–‡ä»¶çš„ä½ç½®
train: ./score/images/train
val: ./score/images/val

# number of classes
nc: 3

# class names
names: ['person', 'head', 'helmet']

```

#### 1.2 åˆ›å»ºæ¯ä¸ªå›¾ç‰‡å¯¹åº”çš„æ ‡ç­¾æ–‡ä»¶

ä½ å¯ä»¥ä½¿ç”¨ `data/gen_data/gen_head_helmet.py` æ¥å°†`VOC` çš„æ•°æ®é›†è½¬æ¢æˆ `YOLOv5` è®­ç»ƒéœ€è¦ç”¨åˆ°çš„æ ¼å¼ã€‚

ä½¿ç”¨æ ‡æ³¨å·¥å…·ç±»ä¼¼äº  ã€ ã€ æ ‡æ³¨ä¹‹åï¼Œéœ€è¦ç”Ÿæˆæ¯ä¸ªå›¾ç‰‡å¯¹åº”çš„ `.txt` æ–‡ä»¶ï¼Œå…¶è§„èŒƒå¦‚ä¸‹ï¼š
- æ¯ä¸€è¡Œéƒ½æ˜¯ä¸€ä¸ªç›®æ ‡- ç±»åˆ«åºå·æ˜¯é›¶ç´¢å¼•å¼€å§‹çš„ï¼ˆä»0å¼€å§‹ï¼‰- æ¯ä¸€è¡Œçš„åæ ‡ `class x_center y_center width height` æ ¼å¼- æ¡†åæ ‡å¿…é¡»é‡‡ç”¨**å½’ä¸€åŒ–çš„ xywh**æ ¼å¼ï¼ˆä»0åˆ°1ï¼‰ã€‚å¦‚æœæ‚¨çš„æ¡†ä»¥åƒç´ ä¸ºå•ä½ï¼Œåˆ™å°†`x_center`å’Œ`width`é™¤ä»¥å›¾åƒå®½åº¦ï¼Œå°†`y_center`å’Œ`height`é™¤ä»¥å›¾åƒé«˜åº¦ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
import numpy as np
def convert(size, box):
    """
    å°†æ ‡æ³¨çš„ xml æ–‡ä»¶ç”Ÿæˆçš„ã€å·¦ä¸Šè§’x,å·¦ä¸Šè§’y,å³ä¸‹è§’xï¼Œå³ä¸‹è§’yã€‘æ ‡æ³¨è½¬æ¢ä¸ºyolov5è®­ç»ƒçš„åæ ‡
    :param size: å›¾ç‰‡çš„å°ºå¯¸ï¼š [w,h]
    :param box: anchor box çš„åæ ‡ [å·¦ä¸Šè§’x,å·¦ä¸Šè§’y,å³ä¸‹è§’x,å³ä¸‹è§’y,]
    :return: è½¬æ¢åçš„ [x,y,w,h]
    """

    x1 = int(box[0])
    y1 = int(box[1])
    x2 = int(box[2])
    y2 = int(box[3])

    dw = np.float32(1. / int(size[0]))
    dh = np.float32(1. / int(size[1]))

    w = x2 - x1
    h = y2 - y1
    x = x1 + (w / 2)
    y = y1 + (h / 2)

    x = x * dw
    w = w * dw
    y = y * dh
    h = h * dh
    return [x, y, w, h]

```

ç”Ÿæˆçš„ `.txt` æ–‡ä»¶æ”¾ç½®çš„åå­—æ˜¯å›¾ç‰‡çš„åå­—ï¼Œæ”¾ç½®åœ¨ label æ–‡ä»¶å¤¹ä¸­ï¼Œä¾‹å¦‚ï¼š

```
./score/images/train/00001.jpg  # image
./score/labels/train/00001.txt  # label

```

ç”Ÿæˆçš„ `.txt` ä¾‹å­ï¼š

```
1 0.1830000086920336 0.1396396430209279 0.13400000636465847 0.15915916301310062
1 0.5240000248886645 0.29129129834473133 0.0800000037997961 0.16816817224025726
1 0.6060000287834555 0.29579580295830965 0.08400000398978591 0.1771771814674139
1 0.6760000321082771 0.25375375989824533 0.10000000474974513 0.21321321837604046
0 0.39300001866649836 0.2552552614361048 0.17800000845454633 0.2822822891175747
0 0.7200000341981649 0.5570570705458522 0.25200001196935773 0.4294294398277998
0 0.7720000366680324 0.2567567629739642 0.1520000072196126 0.23123123683035374

```

#### 1.3 æ–‡ä»¶æ”¾ç½®è§„èŒƒ

æ–‡ä»¶æ ‘å¦‚ä¸‹

[å¤–é“¾å›¾ç‰‡è½¬å­˜å¤±è´¥,æºç«™å¯èƒ½æœ‰é˜²ç›—é“¾æœºåˆ¶,å»ºè®®å°†å›¾ç‰‡ä¿å­˜ä¸‹æ¥ç›´æ¥ä¸Šä¼ (img-nvidZNJ5-1672906394071)(./doc/File_tree.png)]

#### 1.4 é€‰æ‹©ä¸€ä¸ªæ‚¨éœ€è¦çš„æ¨¡å‹

åœ¨æ–‡ä»¶å¤¹ `./models` ä¸‹é€‰æ‹©ä¸€ä¸ªä½ éœ€è¦çš„æ¨¡å‹ç„¶åå¤åˆ¶ä¸€ä»½å‡ºæ¥ï¼Œå°†æ–‡ä»¶å¼€å¤´çš„ `nc =` ä¿®æ”¹ä¸ºæ•°æ®é›†çš„åˆ†ç±»æ•°ï¼Œä¸‹é¢æ˜¯å€Ÿé‰´ `./models/yolov5s.yaml`æ¥ä¿®æ”¹çš„

```
# parameters
nc: 3  # number of classes     &lt;============ ä¿®æ”¹è¿™é‡Œä¸ºæ•°æ®é›†çš„åˆ†ç±»æ•°
depth_multiple: 0.33  # model depth multiple
width_multiple: 0.50  # layer channel multiple

# anchors
anchors:
  - [10,13, 16,30, 33,23]  # P3/8
  - [30,61, 62,45, 59,119]  # P4/16
  - [116,90, 156,198, 373,326]  # P5/32

# YOLOv5 backbone
backbone:
  # [from, number, module, args]
  [[-1, 1, Focus, [64, 3]],  # 0-P1/2
   [-1, 1, Conv, [128, 3, 2]],  # 1-P2/4
   [-1, 3, BottleneckCSP, [128]],
   [-1, 1, Conv, [256, 3, 2]],  # 3-P3/8
   [-1, 9, BottleneckCSP, [256]],
   [-1, 1, Conv, [512, 3, 2]],  # 5-P4/16
   [-1, 9, BottleneckCSP, [512]],
   [-1, 1, Conv, [1024, 3, 2]],  # 7-P5/32
   [-1, 1, SPP, [1024, [5, 9, 13]]],
   [-1, 3, BottleneckCSP, [1024, False]],  # 9
  ]

# YOLOv5 head
head:
  [[-1, 1, Conv, [512, 1, 1]],
   [-1, 1, nn.Upsample, [None, 2, 'nearest']],
   [[-1, 6], 1, Concat, [1]],  # cat backbone P4
   [-1, 3, BottleneckCSP, [512, False]],  # 13

   [-1, 1, Conv, [256, 1, 1]],
   [-1, 1, nn.Upsample, [None, 2, 'nearest']],
   [[-1, 4], 1, Concat, [1]],  # cat backbone P3
   [-1, 3, BottleneckCSP, [256, False]],  # 17

   [-1, 1, Conv, [256, 3, 2]],
   [[-1, 14], 1, Concat, [1]],  # cat head P4
   [-1, 3, BottleneckCSP, [512, False]],  # 20

   [-1, 1, Conv, [512, 3, 2]],
   [[-1, 10], 1, Concat, [1]],  # cat head P5
   [-1, 3, BottleneckCSP, [1024, False]],  # 23

   [[17, 20, 23], 1, Detect, [nc, anchors]],  # Detect(P3, P4, P5)
  ]


```

#### 1.5 å¼€å§‹è®­ç»ƒ

è¿™é‡Œé€‰æ‹©äº† `yolov5s` æ¨¡å‹è¿›è¡Œè®­ç»ƒï¼Œæƒé‡ä¹Ÿæ˜¯åŸºäº `yolov5s.pt` æ¥è®­ç»ƒ

```
python train.py --img 640 \
                --batch 16 --epochs 10 --data ./data/custom_data.yaml \
                --cfg ./models/custom_yolov5.yaml --weights ./weights/yolov5s.pt

```

å…¶ä¸­ï¼Œ`yolov5s.pt` éœ€è¦è‡ªè¡Œä¸‹è½½æ”¾åœ¨æœ¬å·¥ç¨‹çš„æ ¹ç›®å½•å³å¯ï¼Œä¸‹è½½åœ°å€ 

#### 1.6 çœ‹è®­ç»ƒä¹‹åçš„ç»“æœ

è®­ç»ƒä¹‹åï¼Œæƒé‡ä¼šä¿å­˜åœ¨ `./runs` æ–‡ä»¶å¤¹é‡Œé¢çš„æ¯ä¸ª `exp` æ–‡ä»¶é‡Œé¢çš„ `weights/best.py` ï¼Œé‡Œé¢è¿˜å¯ä»¥çœ‹åˆ°è®­ç»ƒçš„æ•ˆæœ <img src="https://img-blog.csdnimg.cn/img_convert/a0146adabdeb12dec72d4b04dd2a4dff.jpeg" alt="">

## 2. ä¾¦æµ‹

ä¾¦æµ‹å›¾ç‰‡ä¼šä¿å­˜åœ¨ `./inferenct/output/` æ–‡ä»¶å¤¹ä¸‹

è¿è¡Œå‘½ä»¤ï¼š

```
python detect.py --source   0  # webcam
                            file.jpg  # image 
                            file.mp4  # video
                            path/  # directory
                            path/*.jpg  # glob
                            rtsp://170.93.143.139/rtplive/470011e600ef003a004ee33696235daa  # rtsp stream
                            http://112.50.243.8/PLTV/88888888/224/3221225900/1.m3u8  # http stream

```

ä¾‹å¦‚ä½¿ç”¨æˆ‘çš„ `s` æƒé‡æ£€æµ‹å›¾ç‰‡ï¼Œå¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œä¾¦æµ‹å›¾ç‰‡ä¼šä¿å­˜åœ¨ `./inferenct/output/` æ–‡ä»¶å¤¹ä¸‹

```
python detect.py --source å›¾ç‰‡è·¯å¾„ --weights ./weights/helmet_head_person_s.pt

```

## 3. æ£€æµ‹å±é™©åŒºåŸŸå†…æ˜¯å¦æœ‰äºº

### 3.1 å±é™©åŒºåŸŸæ ‡æ³¨æ–¹å¼

æˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯  æ ‡æ³¨ï¼Œç”Ÿæˆäº†å¯¹åº”å›¾ç‰‡çš„ json æ–‡ä»¶

### 3.2 æ‰§è¡Œä¾¦æµ‹

ä¾¦æµ‹å›¾ç‰‡ä¼šä¿å­˜åœ¨ `./inferenct/output/` æ–‡ä»¶å¤¹ä¸‹

è¿è¡Œå‘½ä»¤ï¼š

```
python area_detect.py --source ./area_dangerous --weights ./weights/helmet_head_person_s.pt

```

### 3.3 æ•ˆæœï¼šå±é™©åŒºåŸŸä¼šä½¿ç”¨ **çº¢è‰²æ¡†** æ ‡å‡ºæ¥ï¼ŒåŒæ—¶ï¼Œå±é™©åŒºåŸŸé‡Œé¢çš„äººä½“ä¹Ÿä¼šè¢«æ¡†å‡ºæ¥ï¼Œå±é™©åŒºåŸŸå¤–çš„äººä½“ä¸ä¼šè¢«æ¡†é€‰å‡ºæ¥

<img src="https://img-blog.csdnimg.cn/img_convert/c6b3c7edcc9c94b74504f109ff89a544.jpeg" alt=""> <img src="https://img-blog.csdnimg.cn/img_convert/2ed504c8b5c15f7b17615c74d61f4deb.jpeg" alt="">

## 4. ç”Ÿæˆ ONNX

### 4.1 å®‰è£… `onnx` åº“

```
pip install onnx

```

### 4.2 æ‰§è¡Œç”Ÿæˆ

```
python ./models/export.py --weights ./weights/helmet_head_person_s.pt --img 640 --batch 1

```

`onnx` å’Œ `torchscript` æ–‡ä»¶ä¼šç”Ÿæˆåœ¨ `./weights` æ–‡ä»¶å¤¹ä¸­

## 5. å¢åŠ æ•°æ®é›†çš„åˆ†ç±»

å…³äºå¢åŠ æ•°æ®é›†åˆ†ç±»çš„æ–¹æ³•ï¼š

`SHWD` æ•°æ®é›†é‡Œé¢çš„ `person` æŒ‡çš„æ˜¯`å¤´ï¼ˆheadï¼‰`ï¼Œæ²¡æœ‰ `äººä½“` çš„ç±»åˆ«ï¼Œå…ˆå°†ç°æœ‰çš„è‡ªå·±çš„æ•°æ®é›†æ‰§è¡Œè„šæœ¬ç”Ÿæˆ yolov5 éœ€è¦çš„æ ‡ç­¾æ–‡ä»¶ `.txt`ï¼Œä¹‹åå†ç”¨ `yolov5x.pt` åŠ ä¸Š `yolov5x.yaml` ï¼Œä½¿ç”¨æŒ‡ä»¤æ£€æµ‹å‡ºäººä½“

```
python detect.py --save-txt --source è‡ªå·±æ•°æ®é›†çš„æ–‡ä»¶ç›®å½• --weights ./weights/yolov5x.pt

```

`yolov5` ä¼šæ¨ç†å‡ºæ‰€æœ‰çš„åˆ†ç±»ï¼Œå¹¶åœ¨ `inference/output` ä¸­ç”Ÿæˆå¯¹åº”å›¾ç‰‡çš„ `.txt` æ ‡ç­¾æ–‡ä»¶ï¼›

ä¿®æ”¹ `./data/gen_data/merge_data.py` ä¸­çš„è‡ªå·±æ•°æ®é›†æ ‡ç­¾æ‰€åœ¨çš„è·¯å¾„ï¼Œæ‰§è¡Œè¿™ä¸ªpythonè„šæœ¬ï¼Œä¼šè¿›è¡Œ `äººä½“(person)` ç±»å‹çš„åˆå¹¶

å®Œæ•´ä»£ç ä¸‹è½½åœ°å€ï¼š
